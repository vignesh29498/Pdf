import pdfplumber
import difflib
import pandas as pd

def extract_sentences(pdf_path):
    """Extract sentences from each page and store them with their positions"""
    text_per_page = {}
    with pdfplumber.open(pdf_path) as pdf:
        for page_num, page in enumerate(pdf.pages, start=1):
            text = page.extract_text() or ""
            sentences = [s.strip() for s in text.split(". ") if s.strip()]  # Simple sentence splitting
            text_per_page[page_num] = sentences
    return text_per_page

def overall_pdf_comparison(pdf1_path, pdf2_path, output_csv="pdf_comparison_result.csv"):
    """Compare two PDFs and save deviations in a CSV file"""
    pdf1_text = extract_sentences(pdf1_path)
    pdf2_text = extract_sentences(pdf2_path)

    pdf1_sentences = [(page, idx, sent) for page, sents in pdf1_text.items() for idx, sent in enumerate(sents)]
    pdf2_sentences = [(page, idx, sent) for page, sents in pdf2_text.items() for idx, sent in enumerate(sents)]

    pdf1_sent_list = [sent for _, _, sent in pdf1_sentences]
    pdf2_sent_list = [sent for _, _, sent in pdf2_sentences]

    results = []
    
    # Match sentences using difflib (basic text similarity)
    matcher = difflib.SequenceMatcher(None, pdf1_sent_list, pdf2_sent_list)
    matches = matcher.get_matching_blocks()

    matched_indices = set()
    for match in matches:
        for i in range(match.size):
            matched_indices.add((match.a + i, match.b + i))

    captured_sentences = set()  # To track reported differences

    for i, (sent1_page, sent1_idx, sent1) in enumerate(pdf1_sentences):
        # Check if this sentence has an exact match in PDF2
        matched = next((j for j in matched_indices if j[0] == i), None)

        if matched:
            _, matched_idx = matched
            sent2_page, sent2_idx, sent2 = pdf2_sentences[matched_idx]

            # Ignore exact matches or small position changes within the same page
            if sent1_page == sent2_page and abs(sent1_idx - sent2_idx) <= 1:
                continue  # Ignore small shifts within the same page

            # Capture reordered sentences
            if sent1_page == sent2_page and sent1_idx != sent2_idx:
                description = f"Position swapped within page"
                status = "⚠️ Moved (Reordered)"
            else:
                description = f"Moved to Page {sent2_page}"
                status = "⚠️ Moved (Different Page)"

        else:
            sent2_page, sent2 = None, "(Not Found)"
            description = "Missing in PDF2"
            status = "❌ Mismatch"

        if sent1 not in captured_sentences:
            results.append([sent1_page, sent1, sent2, description, status])
            captured_sentences.add(sent1)

    # Find extra sentences in PDF2
    pdf2_unused = set(range(len(pdf2_sentences))) - {match[1] for match in matched_indices}
    for idx in pdf2_unused:
        sent2_page, _, sent2 = pdf2_sentences[idx]
        if sent2 not in captured_sentences:
            results.append([sent2_page, "(Not Found)", sent2, "Extra in PDF2", "❌ Mismatch"])
            captured_sentences.add(sent2)

    # Convert results to DataFrame and save to CSV
    df = pd.DataFrame(results, columns=["Page Number", "PDF1 Sentence", "PDF2 Sentence", "Description", "Status"])
    df.to_csv(output_csv, index=False)

    print(f"Overall PDF comparison report saved as {output_csv}")

# Example usage
overall_pdf_comparison("sample1.pdf", "sample2.pdf")
